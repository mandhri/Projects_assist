---
title: "RNA-Seq_differential_expression_normalise_by_chromo"
output: html_document
date: "2025-09-30"
---

```{r,packages}


suppressPackageStartupMessages({
library("EnhancedVolcano")
library("limma")
library("biomaRt")
library("annotables")
library("tximport")
library("apeglm")
library("eulerr")
library("DESeq2")
library("HGNChelper")
library("tictoc")
library("DESeq2")
library("kableExtra")
library("beeswarm")
library("missMethyl")
library("gridExtra")
library("png")
library("metafor")
library("ggplot2")
library("purrr")
library("metafor")
library("dplyr")
library("readxl")
library("ggplot2")
library("tidyverse")
library("magrittr")
library("readr")
library("eulerr")
library("RColorBrewer")
library("e1071")
library("plotly") 
library("pheatmap")

})

CORES=16

```

# Read the sample manifest and alignment summary


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

samples<-readRDS("/mnt/vol1/Projects_assist/counts_data.rds")

pheno<-readRDS("/mnt/vol1/Projects_assist/colData.rds")
pheno$ex_code <- rownames(pheno)

stopifnot(all(colnames(samples) %in% pheno$ex_code))
pheno <- pheno[match(colnames(samples), pheno$ex_code), ]
stopifnot(identical(colnames(samples), pheno$ex_code))

rownames(pheno) <- pheno$ex_code

pheno$Seq_Batch <- relevel(pheno$Seq_Batch, ref = "1")
pheno$Sex     <- relevel(pheno$Sex, ref = "Female")
pheno$age_bin <- relevel(pheno$age_bin, ref = "a18_29")

```

# Making DESeqDataSetFromMatrix


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

dds_org <- DESeqDataSetFromMatrix(
  countData = samples,
  colData   = pheno,
  design    = ~ Seq_Batch + age_bin + Sex + age_bin:Sex
)

```


# Filtering for low count and normalisation of the counts

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

keep <- rowSums(counts(dds_org)) >= 10
dds  <- dds_org[keep, ]

dds   <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)

head(norm_counts)


```


# Unsupervised clustering analyses and DE analysis


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

vsd <- vst(dds, blind = TRUE)

# Example correlation heatmap (annotation from pheno)
vsd_cor <- cor(assay(vsd))
pheatmap(
  vsd_cor,
  annotation_col = pheno[, c("Sex","age_bin","Seq_Batch")],
  annotation_row = pheno[, c("Sex","age_bin","Seq_Batch")]
)

# Fit model
dds <- DESeq(dds)

plotDispEsts(dds)


```


#  Model diagnostics


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


# Sample-wise QC with VST 
vsd <- vst(dds, blind = TRUE)

# PCA
plotPCA(vsd, intgroup = c("Sex","age_bin","Seq_Batch"))
plotPCA(vsd, intgroup = c("Sex", "age_bin"))
plotPCA(vsd, intgroup = c("age_bin","Seq_Batch"))

```



```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

coefficients <- resultsNames(dds)
print(coefficients)

ref_age <- "a18_29"
sex_main <- "Sex_Male_vs_Female"

age_bins <- c("a30_39","a40_49","a50_59","a60_69","a70_79")

missing_itx <- setdiff(paste0("age_bin", age_bins, ".SexMale"), coefficients)
length(missing_itx)

# Shrinkage reference bin (a18_29)

results_list <- list()
results_list[[ref_age]] <- lfcShrink(dds, coef = sex_main, type = "apeglm")

# Other age bins use unshrunken list-contrast

for (age in age_bins) {
  int_term <- paste0("age_bin", age, ".SexMale")
  results_list[[age]] <- results(dds, contrast = list(c("Sex_Male_vs_Female", int_term)))
}

# 3) Filter significant DEGs (padj < 0.05 & |LFC| > 1)
results_sig_fc <- lapply(results_list, function(res) {
  res_df <- as.data.frame(res)
  subset(res_df, !is.na(padj) & padj < 0.05 & abs(log2FoldChange) > 1)
})



```

# Annotate DEGs with chromosome info

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

summary_list <- list()

for (contrast_name in names(results_list)) {
  res    <- results_list[[contrast_name]] 
  res_df <- as.data.frame(res)
  res_df$ensembl_gene_id <- sub("\\..*$","", rownames(res_df))
  tested <- sum(!is.na(res_df$padj))

  sig_df <- results_sig_fc[[contrast_name]]
  if (is.null(sig_df)) sig_df <- res_df[0, , drop = FALSE] 
  sig_df$ensembl_gene_id <- sub("\\..*$","", rownames(sig_df))

  summary_list[[contrast_name]] <- data.frame(
    contrast    = contrast_name,
    tested_genes= tested,
    sig_total   = nrow(sig_df),
    sig_higher_in_male      = sum(sig_df$log2FoldChange > 0, na.rm = TRUE),
    sig_higher_in_female    = sum(sig_df$log2FoldChange < 0, na.rm = TRUE)
  )
}

summary_tbl <- do.call(rbind, summary_list)
print(summary_tbl)


```


# Annotate DEGs with chromosome info

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

sig_ids <- unique(sub("\\..*$","", unlist(lapply(results_sig_fc, rownames), use.names = FALSE)))

map <- annotables::grch38[, c("ensgene","chr")]
map$ensgene <- sub("\\..*$","", map$ensgene)
chrom_map <- setNames(map$chr, map$ensgene)

# Fixed classes & palette
classes<- c("Autosome","X","Y","MT","Other")
pal<- setNames(RColorBrewer::brewer.pal(5, "Set2"), classes)

for (age in names(results_sig_fc)) {
  df <- results_sig_fc[[age]]
  if (is.null(df)) next
  if (nrow(df) == 0) next

  ids <- sub("\\..*$","", rownames(df))
  chr <- chrom_map[ids]
  cls <- ifelse(chr %in% as.character(1:22), "Autosome",
         ifelse(chr %in% c("X","Y"), chr,
         ifelse(chr %in% c("MT","M"), "MT", "Other")))

  pie <- as.data.frame(prop.table(table(factor(cls, levels = classes))) * 100)
  names(pie) <- c("chrom","prop")

   g <- ggplot(pie, aes("", prop, fill = chrom)) +
    geom_bar(stat = "identity", width = 1, color = "white") +
    coord_polar("y") +
    geom_text(aes(label = sprintf("%.1f%%", prop)),
              position = position_stack(0.5), size = 3) +
    scale_fill_manual(values = pal, drop = FALSE) +
    theme_void() +
    labs(title = paste("Chromosome distribution —", age), fill = "Chromosome")
     print(g)

}

```



# Enrichment of the DEGs with chromosome info

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


# canonical chromosomes to keep
canon_chr <- c(as.character(1:22), "X","Y","MT")

# 1) DEGs union (for pies)
deg_union <- unique(sub("\\..*$","", unlist(lapply(results_sig_fc, rownames))))

# 2) Per-contrast tested universes (non-NA padj) for enrichment
universes <- lapply(results_list, function(res) {
  df  <- as.data.frame(res)
  ids <- sub("\\..*$","", rownames(df))
  ids[!is.na(df$padj)]
})
univ_union <- unique(unlist(universes))

# 3) Map Ensembl → chromosome (offline)
map_ids <- unique(c(deg_union, univ_union))
gene2chr_raw <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys    = map_ids,
  keytype = "ENSEMBL",
  columns = c("CHR")
)

# 4) clean + keep canonical
gene2chr <- gene2chr_raw %>%
  distinct(ENSEMBL, .keep_all = TRUE) %>%
  transmute(ensembl_gene_id = ENSEMBL,
            chromosome_name = CHR) %>%
  filter(chromosome_name %in% canon_chr)


```


# Annotate DEGs with chromosome info

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

pal <- setNames(brewer.pal(4, "Set2"), c("Autosomes","X","Y","MT"))

for (contrast_name in names(results_sig_fc)) {
  df  <- results_sig_fc[[contrast_name]]
  ids <- sub("\\..*$","", rownames(df))

  ann <- gene2chr %>% filter(ensembl_gene_id %in% ids)

  pie_df <- ann %>%
    mutate(group = case_when(
      chromosome_name %in% as.character(1:22) ~ "Autosomes",
      chromosome_name %in% c("X","Y","MT")    ~ chromosome_name
    )) %>%
    count(group, name = "n") %>%
    mutate(prop = 100 * n / sum(n),
           lab  = paste0(group, " (", round(prop,1), "%)"))

  g <- ggplot(pie_df, aes(x = "", y = prop, fill = group)) +
    geom_bar(stat = "identity", width = 1, colour = "white") +
    coord_polar(theta = "y") +
    geom_text(aes(label = lab), position = position_stack(vjust = 0.5), size = 3) +
    scale_fill_manual(values = pal) +
    theme_void() +
    labs(title = paste0("Chromosome distribution of DEGs — ", contrast_name))

  print(g)
}

```
# Chromosome enrichment (observed vs expected)

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

enrich_all <- list()

for (contrast_name in names(results_list)) {
  # Universe for this contrast (tested genes)
  univ_ids <- universes[[contrast_name]]
  univ_chr <- gene2chr %>% semi_join(tibble(ensembl_gene_id = univ_ids), by = "ensembl_gene_id")
  univ_counts <- univ_chr %>% count(chromosome_name, name = "universe_genes")
  total_univ  <- sum(univ_counts$universe_genes)

  # Observed DEGs for this contrast
  sig_df  <- results_sig_fc[[contrast_name]]
  deg_ids <- if (is.null(sig_df)) character(0) else sub("\\..*$","", rownames(sig_df))
  obs <- univ_chr %>%
    mutate(is_deg = ensembl_gene_id %in% deg_ids) %>%
    count(chromosome_name, wt = is_deg, name = "observed_degs")
  total_deg <- sum(obs$observed_degs)

  # Combine + expected + enrichment
  df <- univ_counts %>%
    left_join(obs, by = "chromosome_name") %>%
    mutate(observed_degs = replace_na(observed_degs, 0L),
           expected_degs = total_deg * (universe_genes / total_univ),
           log2_enrichment = log2( (observed_degs + 1e-9) / (expected_degs + 1e-9) ))

  # Fisher’s exact (per chromosome)
  a <- df$observed_degs
  u <- df$universe_genes
  b <- total_deg - a
  c <- u - a
  d <- (total_univ - u) - b
  df$p_value <- vapply(seq_along(a), function(i) {
    fisher.test(matrix(c(a[i], b[i], c[i], d[i]), nrow = 2, byrow = TRUE))$p.value
  }, numeric(1))
  df$p_adj <- p.adjust(df$p_value, method = "BH")

  df$contrast <- contrast_name
  enrich_all[[contrast_name]] <- df
}

enrich_df <- bind_rows(enrich_all)

ggplot(enrich_df, aes(chromosome_name, log2_enrichment, fill = p_adj < 0.05)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_fill_manual(values = c("grey70","steelblue"), labels = c("NS","FDR<0.05")) +
  labs(x = "Chromosome", y = "log2(observed / expected)", fill = "",
       title = "DEG enrichment vs tested-gene distribution (offline, org.Hs.eg.db)") +
  theme_minimal(base_size = 12) +
  facet_wrap(~ contrast, ncol = 2)

```

##############

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}
options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/<distro>/latest"))

# All genes we need positions for (tested across any contrast)
universes <- lapply(results_list, function(res){
  df <- as.data.frame(res)
  sub("\\..*$","", rownames(df))[!is.na(df$padj)]
})
map_ids <- unique(unlist(universes))

# Ensembl
ensembl <- biomaRt::useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")

gene_pos <- getBM(
  attributes = c("ensembl_gene_id","chromosome_name","start_position","end_position"),
  filters    = "ensembl_gene_id",
  values     = map_ids,
  mart       = ensembl
) %>%
  distinct(ensembl_gene_id, .keep_all = TRUE) %>%
  mutate(mid_bp = (start_position + end_position)/2) %>%
  filter(chromosome_name %in% c(as.character(1:22),"X","Y"))

```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

suppressPackageStartupMessages({ library(rtracklayer); library(GenomeInfoDb); library(dplyr); library(tidyr) })

# UCSC cytoBand (hg38)
session <- browserSession("UCSC"); genome(session) <- "hg38"
cyto <- getTable(ucscTableQuery(session, table="cytoBand")) %>%
  mutate(chrom = sub("^chr","", chrom))

# Chromosome lengths
ci <- GenomeInfoDb::getChromInfoFromUCSC("hg38") %>%
  transmute(chrom = sub("^chr","", chrom), chr_length_bp = size)

# Centromere span = rows with gieStain == "acen"
acen <- cyto %>%
  filter(gieStain == "acen") %>%
  group_by(chrom) %>%
  summarise(cent_start = min(chromStart), cent_end = max(chromEnd), .groups="drop")

# Arm lengths (bp)
arm_table <- ci %>% inner_join(acen, by = "chrom") %>%
  transmute(chromosome_name = chrom,
            p_len_bp = cent_start,
            q_len_bp = chr_length_bp - cent_end)

# Long format, add chrom_arm and Mb
arm_sizes <- arm_table %>%
  pivot_longer(c(p_len_bp, q_len_bp), names_to = "arm", values_to = "len_bp") %>%
  mutate(arm = ifelse(arm == "p_len_bp", "p", "q"),
         chrom_arm = paste0(chromosome_name, arm),
         len_Mb = len_bp/1e6)

```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

gene_arm <- gene_pos %>%
  inner_join(arm_table, by = "chromosome_name") %>%
  mutate(arm = ifelse(mid_bp < p_len_bp, "p", "q"),
         chrom_arm = paste0(chromosome_name, arm)) %>%
  select(ensembl_gene_id, chromosome_name, mid_bp, arm, chrom_arm)


```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

# Build a tidy data.frame: which DEGs are higher in Male vs Female, per contrast
deg_dir <- do.call(rbind, lapply(names(results_sig_fc), function(cn){
  df <- results_sig_fc[[cn]]
  if (is.null(df) || nrow(df) == 0) return(
    data.frame(contrast=character(0), ensembl_gene_id=character(0), dir=character(0))
  )
  data.frame(
    contrast        = cn,
    ensembl_gene_id = sub("\\..*$","", rownames(df)),
    dir             = ifelse(df$log2FoldChange > 0, "higher_in_Male", "higher_in_Female"),
    row.names = NULL
  )
}))


```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

suppressPackageStartupMessages({ library(ggplot2); library(dplyr) })
deg_dir <- dplyr::bind_rows(deg_dir)

# Count DEGs per arm & direction per contrast
deg_arm <- deg_dir %>%
  dplyr::inner_join(gene_arm, by = "ensembl_gene_id") %>%
  dplyr::count(contrast, chrom_arm, dir, name = "deg")

# Merge sizes and compute DEGs per 10 Mb
rates_arm <- arm_sizes %>%
  select(chrom_arm, len_Mb) %>%
  inner_join(deg_arm, by = "chrom_arm") %>%
  mutate(rate_per_10Mb = deg / pmax(len_Mb/10, 1e-9))

# Plot (DNAm-style)
ggplot(rates_arm, aes(x = chrom_arm, y = rate_per_10Mb, fill = dir)) +
  geom_col(position = "dodge") +
  labs(title = "DEG distribution across chromosome arms",
       subtitle = "Normalised by arm size (DEGs per 10 Mb)",
       x = "Chromosome arm", y = "DEGs per 10 Mb", fill = "Direction") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_fill_manual(values = c("higher_in_Male"="tomato", "higher_in_Female"="royalblue")) +
  facet_wrap(~ contrast, ncol = 2, scales = "free_y")


```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}



```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}



```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}



```






















