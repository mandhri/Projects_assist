---
title: "RNA-Seq_differential_expression_normalise_by_chromo"
output: html_document
date: "2025-09-30"
---

```{r,packages}


suppressPackageStartupMessages({
library("EnhancedVolcano")
library("limma")
library("biomaRt")
library("annotables")
library("tximport")
library("apeglm")
library("eulerr")
library("DESeq2")
library("HGNChelper")
library("tictoc")
library("DESeq2")
library("kableExtra")
library("beeswarm")
library("missMethyl")
library("gridExtra")
library("png")
library("metafor")
library("ggplot2")
library("purrr")
library("metafor")
library("dplyr")
library("readxl")
library("ggplot2")
library("tidyverse")
library("magrittr")
library("readr")
library("eulerr")
library("RColorBrewer")
library("e1071")
library("plotly") 
library("pheatmap")
library("rtracklayer")
library("biomaRt")  
library("GenomeInfoDb")  
library("cowplot")  
library("patchwork")

})

CORES=16

```

# Read the sample manifest and alignment summary


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

samples<-readRDS("/mnt/vol1/Projects_assist/Karel/counts_data.rds")

pheno<-readRDS("/mnt/vol1/Projects_assist/Karel/colData.rds")
pheno$ex_code <- rownames(pheno)

stopifnot(all(colnames(samples) %in% pheno$ex_code))
pheno <- pheno[match(colnames(samples), pheno$ex_code), ]
stopifnot(identical(colnames(samples), pheno$ex_code))

rownames(pheno) <- pheno$ex_code

pheno$Seq_Batch <- relevel(pheno$Seq_Batch, ref = "1")
pheno$Sex     <- relevel(pheno$Sex, ref = "Female")
pheno$age_bin <- relevel(pheno$age_bin, ref = "a18_29")

```

# Making DESeqDataSetFromMatrix


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

dds_org <- DESeqDataSetFromMatrix(
  countData = samples,
  colData   = pheno,
  design    = ~ Seq_Batch + age_bin + Sex + age_bin:Sex
)

```


# Filtering for low count and normalisation of the counts

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

keep <- rowSums(counts(dds_org)) >= 10
dds  <- dds_org[keep, ]

dds   <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)
glimpse(norm_counts)

```


## Unsupervised clustering analyses and DE analysis

Sample-to-sample structure was assessed on variance-stabilised counts (`vst`, blind = TRUE).  
A correlation heat map was drawn with annotations for `Sex`, `age_bin`, and `Seq_Batch`.  
Differential expression was then fitted on raw counts using the specified design, and dispersion
estimates were inspected.

### Heat map (sample–sample correlations)
- High correlations (~0.94–1) across samples indicate consistent libraries.
- A clear two-block structure suggests an expected batch effect.
- `Sex` and `age_bin` appear mixed within each block, indicating no obvious confounding.

### Dispersion plot
- Gene-wise (black) dispersions decline with mean; the fitted trend (red) is smooth.
- Final estimates (blue) largely follow the fit, consistent with effective shrinkage.
- Wide spread at low means is expected; a few extremes likely reflect very sparse or near-constant genes.



```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

vsd <- vst(dds, blind = TRUE)

# Example correlation heatmap (annotation from pheno)
vsd_cor <- cor(assay(vsd))
pheatmap(
  vsd_cor,
  annotation_col = pheno[, c("Sex","age_bin","Seq_Batch")],
  annotation_row = pheno[, c("Sex","age_bin","Seq_Batch")]
)

# Fit model
dds <- DESeq(dds)

plotDispEsts(dds)


```


#  Model diagnostics

A variance-stabilising transform (vst, blind = TRUE) was applied to counts for unsupervised QC. PCA was computed on the most variable genes (plotPCA(..., returnData = TRUE)), and the percentage variance was used for axis labels. Samples were then visualised as: Sex × Batch (colour = Sex, shape = Seq_Batch), Sex × age_bin (colour = Sex:age_bin), age_bin × Batch (colour = age_bin, shape = Seq_Batch), plus single-factor views for Sex and age_bin. These plots were used to verify batch mixing and the consistency of sex/age patterns across batches. Differential expression was fitted on raw counts with the full design.


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


# Sample-wise QC with VST 
vsd <- vst(dds, blind = TRUE)

pdat <- DESeq2::plotPCA(vsd, intgroup = c("Sex", "age_bin", "Seq_Batch"), returnData = TRUE)
pv <- round(100 * attr(pdat, "percentVar")) 

# PCA

# Sex + Seq_Batch
ggplot(pdat, aes(PC1, PC2, colour = Sex, shape = Seq_Batch)) +
  geom_point(size = 2) +
  labs(x = paste0("PC1: ", pv[1], "% variance"),
       y = paste0("PC2: ", pv[2], "% variance"),
       title = "PCA: Sex (colour), Batch (shape)")

#Sex + age_bin (combine into one colour)
pdat$Sex_age <- interaction(pdat$Sex, pdat$age_bin, sep = ":")
ggplot(pdat, aes(PC1, PC2, colour = Sex_age)) +
  geom_point(size = 2) +
  labs(x = paste0("PC1: ", pv[1], "% variance"),
       y = paste0("PC2: ", pv[2], "% variance"),
       title = "PCA: Sex:age_bin (colour)")

#age_bin + Seq_Batch
ggplot(pdat, aes(PC1, PC2, colour = age_bin, shape = Seq_Batch)) +
  geom_point(size = 2) +
  labs(x = paste0("PC1: ", pv[1], "% variance"),
       y = paste0("PC2: ", pv[2], "% variance"),
       title = "PCA: age_bin (colour), Batch (shape)")

#Sex only
ggplot(pdat, aes(PC1, PC2, colour = Sex)) +
  geom_point(size = 2) +
  labs(x = paste0("PC1: ", pv[1], "% variance"),
       y = paste0("PC2: ", pv[2], "% variance"),
       title = "PCA: Sex")

#age_bin only
ggplot(pdat, aes(PC1, PC2, colour = age_bin)) +
  geom_point(size = 2) +
  labs(x = paste0("PC1: ", pv[1], "% variance"),
       y = paste0("PC2: ", pv[2], "% variance"),
       title = "PCA: age_bin")


```

# Shrinkage

Note: 
Raw LFCs can be noisy, especially for low counts. Shrinkage pulls extreme values towards zero, yielding more stable effect sizes and cleaner ranking. Wald p-values and adjusted p remain from the unshrunken fit; shrinkage mainly improves interpretation and any LFC thresholds.

Analysis:
For each age bin, the sex effect was defined as the main Sex coefficient at the reference age plus the age×Sex interaction. Log fold changes were shrunk with ashr for all bins to stabilise effect sizes, while Wald p-values and FDR from the unshrunken results were used.

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

coeffs   <- resultsNames(dds)
print(coeffs)
ref_age  <- "a18_29"
bins     <- c(ref_age, "a30_39","a40_49","a50_59","a60_69","a70_79")
sex_main <- "Sex_Male_vs_Female"

# Compare raw vs shrunken LFCs per age bin

res_all_ba <- NULL
for (age in bins) {
  if (age == ref_age) {
    raw_res <- results(dds, name = sex_main)
    shr_res <- lfcShrink(dds, coef = sex_main, type = "ashr")
  } else {
    term    <- paste0("age_bin", age, ".SexMale")
    raw_res <- results(dds, contrast = list(c(sex_main, term)))
    shr_res <- lfcShrink(dds, contrast = list(c(sex_main, term)), type = "ashr")
  }

  df <- data.frame(
    gene            = rownames(raw_res),
    lfc_raw         = raw_res$log2FoldChange,   # before shrinkage
    lfc_shr         = shr_res$log2FoldChange,   # after shrinkage
    lfcSE_raw       = raw_res$lfcSE,
    stat_raw        = raw_res$stat,
    pvalue_raw      = raw_res$pvalue,
    FDR_raw         = raw_res$padj,            
    contrast        = age,
    stringsAsFactors = FALSE
  )

  res_all_ba <- rbind(res_all_ba, df)
}


res_long <- res_all_ba %>%
  mutate(
    hit_raw = !is.na(FDR_raw) & FDR_raw <= 0.05 & abs(lfc_raw) >= 0.5,
    hit_shr = !is.na(FDR_raw) & FDR_raw <= 0.05 & abs(lfc_shr) >= 0.5
  ) %>%
  select(gene, contrast, FDR_raw, lfc_raw, lfc_shr, hit_raw, hit_shr) %>%
  tidyr::pivot_longer(
    cols = c(lfc_raw, lfc_shr, hit_raw, hit_shr),
    names_to = c(".value","lfc_type"),
    names_pattern = "(lfc|hit)_(raw|shr)"
  ) %>%
  mutate(
    lfc_type = dplyr::recode(lfc_type,
      raw = "Raw LFC (before)",
      shr = "Shrunken LFC (after)"
    ),
    contrast = factor(contrast, levels = c("a18_29","a30_39","a40_49","a50_59","a60_69","a70_79")),
    lfc_type = factor(lfc_type, levels = c("Raw LFC (before)", "Shrunken LFC (after)"))
  )

x_lim <- c(-3, 3) 
y_max <- quantile(-log10(res_long$FDR_raw), 0.995, na.rm = TRUE)
y_lim <- c(0, max(5, y_max))

p_volcano <- ggplot(res_long, aes(lfc, -log10(FDR_raw), colour = hit)) +
  geom_point(alpha = 0.6, size = 1.2) +
  geom_vline(xintercept = c(-0.5, 0.5), linetype = 2) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  coord_cartesian(xlim = x_lim, ylim = y_lim) +
  facet_grid(contrast ~ lfc_type, switch = "y") +  
  scale_colour_manual(values = c("FALSE" = "grey60", "TRUE" = "steelblue4")) +
  labs(
    title = "Volcano: Raw (left) vs Shrunken (right)",
    x = "log2 fold change",
    y = expression(-log[10]("FDR from unshrunken fit")),
    colour = "FDR≤0.05 & |LFC|≥0.5"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    strip.placement = "outside",
    strip.background = element_blank(),
    strip.text.x = element_text(face = "bold"),
    strip.text.y.left = element_text(angle = 0, face = "bold"),
    panel.grid.minor = element_blank()
  )

p_volcano


```

# Distribution of genes between sexes in each age band

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


results_list <- split(res_all_ba, res_all_ba$contrast)
results_list <- lapply(results_list, function(df) {
  out <- df
  out$log2FoldChange <- df$lfc_raw     # raw LFC 
  out$lfc_shr         <- df$lfc_shr    # shrunken LFC
  out$padj            <- df$FDR_raw    # unshrunken FDR
  rownames(out) <- df$gene
  out
})

#FDR on unshrunken stats + |LFC| on shrunken
FDR_thr <- 0.05
lfc_thr  <- 1

#Results wiht shrinking
results_sig_fc <- lapply(results_list, function(df) {
  keep <- !is.na(df$padj) & df$padj < FDR_thr & abs(df$lfc_shr) >= lfc_thr
  df[keep, , drop = FALSE]
})


#Results without shrinking
results_sig_fc_raw <- lapply(results_list, function(df) {
  keep <- !is.na(df$padj) & df$padj < FDR_thr & abs(df$lfc_raw) >= lfc_thr
  df[keep, , drop = FALSE]
})

# Effect direction (Higher in males/ females) with referencce to shrinking
summary_list <- lapply(names(results_list), function(contrast_name) {
  res_df <- as.data.frame(results_list[[contrast_name]])
  tested <- sum(!is.na(res_df$padj))

  sig_df <- results_sig_fc[[contrast_name]]
  if (is.null(sig_df)) sig_df <- res_df[0, , drop = FALSE]

  data.frame(
    contrast             = contrast_name,
    tested_genes         = tested,
    sig_total            = nrow(sig_df),
    sig_higher_in_male   = sum(sig_df$lfc_shr > 0, na.rm = TRUE),   #shrunken
    sig_higher_in_female = sum(sig_df$lfc_shr < 0, na.rm = TRUE)    #shrunken
  )
})
summary_tbl <- do.call(rbind, summary_list)
print(summary_tbl)


```


# Distribution of chromosomes in each age band

Applying shrinkage (ashr) reduced autosomal borderline effects, increasing the relative contribution of genes on X/Y among significant sex differences within multiple age bins


```{r fig.width=16, fig.height=5, message=FALSE, warning=FALSE, echo=TRUE}


sig_ids <- unique(sub("\\..*$","",
  c(unlist(lapply(results_sig_fc,      rownames), use.names = FALSE),
    unlist(lapply(results_sig_fc_raw, rownames), use.names = FALSE))
))

# map chromosome via Ensembl (GRCh38)
ens <- useEnsembl("genes", dataset = "hsapiens_gene_ensembl")
map_df <- getBM(
  attributes = c("ensembl_gene_id", "chromosome_name"),
  filters    = "ensembl_gene_id",
  values     = sig_ids,
  mart       = ens
)

# normalise chromosome labels.
map_df$chromosome_name <- dplyr::case_when(
  map_df$chromosome_name %in% as.character(1:22) ~ map_df$chromosome_name,
  map_df$chromosome_name %in% c("X","Y","MT","M") ~ ifelse(map_df$chromosome_name=="M","MT", map_df$chromosome_name),
  TRUE ~ NA_character_
)

chrom_map <- setNames(map_df$chromosome_name, map_df$ensembl_gene_id)

# Fixed classes & palette
classes<- c("Autosome","X","Y","MT","Other")
pal<- setNames(RColorBrewer::brewer.pal(5, "Set2"), classes)


#Chromosomal distribution for shrinken logfc
pies_shr <- list()                               
title_prefix <- "Chromosome distribution: shrunken LFC"
for (age in names(results_sig_fc)) {
  df <- results_sig_fc[[age]]
  if (is.null(df) || nrow(df) == 0) next

  ids <- sub("\\..*$","", rownames(df))
  chr <- chrom_map[ids]
  cls <- ifelse(chr %in% as.character(1:22), "Autosome",
         ifelse(chr %in% c("X","Y","MT"), chr, "Other"))

  pie <- as.data.frame(prop.table(table(factor(cls, levels = classes))) * 100)
  names(pie) <- c("chrom","prop")

  g <- ggplot(pie, aes("", prop, fill = chrom)) +
    geom_bar(stat = "identity", width = 1, color = "white") +
    coord_polar("y") +
    geom_text(aes(label = sprintf("%.1f%%", prop)),
              position = position_stack(0.5), size = 3) +
    scale_fill_manual(values = pal, drop = FALSE) +
    theme_void() +
    labs(title = paste(title_prefix, age), fill = "Chromosome")
  # print(g)
    pies_shr[[age]] <- g

}




#Chromosomal distribution for unshrinken logfc

pies_raw <- list() 
title_prefix <- "Chromosome distribution: Unshrunken LFC"
for (age in names(results_sig_fc_raw)) {
  df <- results_sig_fc_raw[[age]]
  if (is.null(df) || nrow(df) == 0) next

  ids <- sub("\\..*$","", rownames(df))
  chr <- chrom_map[ids]
  cls <- ifelse(chr %in% as.character(1:22), "Autosome",
         ifelse(chr %in% c("X","Y","MT"), chr, "Other"))

  pie <- as.data.frame(prop.table(table(factor(cls, levels = classes))) * 100)
  names(pie) <- c("chrom","prop")

  g <- ggplot(pie, aes("", prop, fill = chrom)) +
    geom_bar(stat = "identity", width = 1, color = "white") +
    coord_polar("y") +
    geom_text(aes(label = sprintf("%.1f%%", prop)),
              position = position_stack(0.5), size = 3) +
    scale_fill_manual(values = pal, drop = FALSE) +
    theme_void() +
    labs(title = paste(title_prefix, age), fill = "Chromosome")
    pies_raw[[age]] <- g

  #print(g)
}


```

# Same as above but in panel 


```{r fig.width=20, fig.height=8, message=FALSE, warning=FALSE, echo=TRUE}

label_min_pct <- 3    
base_size_pt  <- 16
label_size_pt <- 5


make_pie_df <- function(res_list, type_label){
  out <- lapply(names(res_list), function(age){
    df <- res_list[[age]]
    if (is.null(df) || nrow(df)==0) return(NULL)
    ids <- sub("\\..*$","", rownames(df))
    chr <- chrom_map[ids]
    cls <- ifelse(chr %in% as.character(1:22), "Autosome",
                  ifelse(chr %in% c("X","Y","MT"), chr, "Other"))
    pie <- as.data.frame(prop.table(table(factor(cls, levels = classes))) * 100)
    names(pie) <- c("chrom","prop")
    pie$Age  <- age
    pie$Type <- type_label
    pie
  })
  dplyr::bind_rows(out)
}

df_raw <- make_pie_df(results_sig_fc_raw, "Unshrunken")
df_shr <- make_pie_df(results_sig_fc,      "Shrunken")

# keep the raw order of ages on both rows
ages <- intersect(unique(df_raw$Age), unique(df_shr$Age))
df <- bind_rows(df_raw, df_shr) %>%
  mutate(
    Age  = factor(Age, levels = ages),
    Type = factor(Type, levels = c("Unshrunken","Shrunken")),
    lab  = ifelse(is.na(prop) | prop < label_min_pct, "", sprintf("%.1f%%", prop))
  )

p <- ggplot(df, aes(x="", y=prop, fill=chrom)) +
  geom_bar(stat="identity", width=1, colour="white") +
  coord_polar("y") +
  geom_text(aes(label = lab), position = position_stack(0.5),
            size = label_size_pt, na.rm = TRUE) +
  scale_fill_manual(values = pal, drop = FALSE, name = "Chromosome") +
  facet_grid(Type ~ Age, switch = "y") +
  theme_void(base_size = base_size_pt) +
  theme(
    strip.text.x = element_text(face = "bold", size = base_size_pt + 2),
    strip.text.y = element_text(face = "bold"),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold", size = base_size_pt + 4),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  labs(
    title = "Chromosome distribution by age bins"
  )

p

```
# Per-chromosome normalised

For each age bin, significant vs tested within the same chromosome is compared for normalisation.

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

INCLUDE_OTHER <- FALSE
classes <- if (INCLUDE_OTHER) c("Autosome","X","Y","MT","Other") else c("Autosome","X","Y","MT")

classify_chr <- function(chr){
  out <- ifelse(chr %in% as.character(1:22), "Autosome",
         ifelse(chr %in% c("X","Y","MT"), chr, "Other"))
  if (!INCLUDE_OTHER) out[!(out %in% classes)] <- NA_character_
  out
}

age_levels <- c("a18_29","a30_39","a40_49","a50_59","a60_69","a70_79")

# Build "tested" background per age × chromosome (from your results_list)
tested_df <- map_dfr(names(results_list), function(age){
  df  <- results_list[[age]]
  ids <- sub("\\..*$","", rownames(df))
  chr <- classify_chr(chrom_map[ids])
  tibble(Age = age, chrom = chr, tested = !is.na(df$padj))
}) %>%
  filter(tested, !is.na(chrom)) %>%
  count(Age, chrom, name = "tested_n") %>%
  mutate(Age = factor(Age, levels = age_levels),
         chrom = factor(chrom, levels = classes)) %>%
  complete(Age, chrom, fill = list(tested_n = 0L))

tested_df

```



```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

normalise_sig_rates <- function(sig_list, label){
  # counts of significant genes per age × chromosome
  sig_counts <- map_dfr(names(sig_list), function(age){
    sig_df <- sig_list[[age]]
    sig_ids <- if (!is.null(sig_df) && nrow(sig_df) > 0)
      sub("\\..*$","", rownames(sig_df)) else character(0)
    chr <- classify_chr(chrom_map[sig_ids])
    tibble(Age = age, chrom = chr) %>%
      filter(!is.na(chrom)) %>%
      count(Age, chrom, name = "sig_n")
  }) %>%
    mutate(Age = factor(Age, levels = age_levels),
           chrom = factor(chrom, levels = classes)) %>%
    complete(Age, chrom, fill = list(sig_n = 0L))  # full grid, zero-filled

  # join background and compute rates
  out <- tested_df %>%
    left_join(sig_counts, by = c("Age","chrom")) %>%
    mutate(sig_n = replace_na(sig_n, 0L),
           rate  = if_else(tested_n > 0, sig_n / tested_n, NA_real_)) %>%
    group_by(Age) %>%
    mutate(rate_pct = 100 * rate / sum(rate, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(Type = label)

  # add totals for convenience
  totals <- out %>%
    group_by(Age) %>%
    summarise(Type    = first(Type),
              n_tested = sum(tested_n, na.rm = TRUE),
              n_sig    = sum(sig_n,    na.rm = TRUE),
              .groups = "drop")

  list(rates = out, totals = totals)
}

RAW  <- normalise_sig_rates(results_sig_fc_raw, "Unshrunken")
SHRN <- normalise_sig_rates(results_sig_fc,      "Shrunken")

norm_raw  <- RAW$rates   # columns: Age, chrom, tested_n, sig_n, rate, rate_pct, Type
tot_raw   <- RAW$totals  # columns: Age, Type, n_tested, n_sig
norm_shr  <- SHRN$rates
tot_shr   <- SHRN$totals

# Ensure we actually have non-empty ages (avoids your earlier faceting error)
norm_raw  %>% group_by(Age) %>% summarise(any_rate = any(!is.na(rate) & rate > 0)) 
norm_shr  %>% group_by(Age) %>% summarise(any_rate = any(!is.na(rate) & rate > 0))

# Peek at the percentages you’ll use for pies
norm_raw  %>% select(Age, chrom, rate_pct)  %>% arrange(Age, chrom) %>% head(20)
norm_shr  %>% select(Age, chrom, rate_pct)  %>% arrange(Age, chrom) %>% head(20)


```


```{r fig.width=18, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}



library(ggplot2)
library(dplyr)

# Draw a panel of normalised pies for one data frame (raw OR shrunken)
plot_pies <- function(df_rates, df_totals, title_text,
                      classes = c("Autosome","X","Y","MT"),
                      pal,                      # named palette, e.g. Set2
                      label_min_pct = 3,
                      base_size_pt  = 16,
                      label_size_pt = 5,
                      ncol_facets   = 3) {

  # Facet order from totals
  age_levels <- as.character(df_totals$Age)

  # ensure factors + safe labels
  df_rates <- df_rates %>%
    mutate(
      Age     = factor(Age,  levels = age_levels),
      chrom   = factor(chrom, levels = classes),
      rate    = ifelse(is.na(rate), 0, rate)  # guard against NA
    ) %>%
    group_by(Age) %>%
    mutate(
      rate_pct = 100 * rate / sum(rate, na.rm = TRUE),
      lab      = ifelse(is.na(rate_pct) | rate_pct < label_min_pct, "",
                        sprintf("%.1f%%", rate_pct))
    ) %>%
    ungroup()

  # facet strip labels with n_sig / n_tested
  df_totals <- df_totals %>% mutate(Age = factor(Age, levels = age_levels))
  lab_map <- setNames(
    paste0(as.character(df_totals$Age),
           "\n(n_sig=", format(df_totals$n_sig, big.mark = ","),
           ", tested=", format(df_totals$n_tested, big.mark = ","), ")"),
    as.character(df_totals$Age)
  )

  ggplot(df_rates, aes(x = "", y = rate_pct, fill = chrom)) +
    geom_bar(stat = "identity", width = 1, colour = "white") +
    coord_polar("y") +
    geom_text(aes(label = lab),
              position = position_stack(0.5), size = label_size_pt, na.rm = TRUE) +
    scale_fill_manual(values = pal, drop = FALSE, name = "Chromosome") +
    facet_wrap(~ Age, ncol = ncol_facets, labeller = labeller(Age = lab_map)) +
    theme_void(base_size = base_size_pt) +
    theme(
      strip.text = element_text(face = "bold", size = base_size_pt + 2),
      legend.position = "bottom",
      plot.title = element_text(hjust = 0.5, face = "bold", size = base_size_pt + 4),
      panel.spacing.y = grid::unit(18, "pt")   # extra vertical breathing room
    ) +
    labs(title = title_text)
}

# ---- Make the two separate panels ----
p_norm_raw <- plot_pies(
  df_rates   = norm_raw,
  df_totals  = tot_raw,
  title_text = "Chromosome *hit-rate* distribution by age bin (normalised) — Unshrunken",
  classes    = classes,
  pal        = pal,
  ncol_facets = 3
)

p_norm_shr <- plot_pies(
  df_rates   = norm_shr,
  df_totals  = tot_shr,
  title_text = "Chromosome *hit-rate* distribution by age bin (normalised) — Shrunken",
  classes    = classes,
  pal        = pal,
  ncol_facets = 3
)

# Show them
p_norm_raw
p_norm_shr

# Optional save (adjust sizes to your liking)
# ggsave("pies_unshrunken_normalised.png", p_norm_raw, width = 16, height = 5, dpi = 300)
# ggsave("pies_shrunken_normalised.png",   p_norm_shr, width = 16, height = 5, dpi = 300)


```


############### Chromosome enrichment (observed vs expected)############

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


# All tested Ensembl IDs across bins
universes <- lapply(results_list, function(res){
  df <- as.data.frame(res)
  sub("\\..*$","", rownames(df))[!is.na(df$padj)]
})
map_ids <- unique(unlist(universes))

# Ensembl gene positions
ensembl <- biomaRt::useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")
gene_pos <- getBM(
  attributes = c("ensembl_gene_id","chromosome_name","start_position","end_position"),
  filters    = "ensembl_gene_id", values = map_ids, mart = ensembl
) %>%
  distinct(ensembl_gene_id, .keep_all = TRUE) %>%
  filter(chromosome_name %in% c(as.character(1:22), "X", "Y")) %>%
  mutate(mid_bp = 0.5 * (start_position + end_position))

# UCSC cytoBand (hg38) → centromeres → arm lengths
session <- browserSession("UCSC"); genome(session) <- "hg38"
cyto <- rtracklayer::getTable(ucscTableQuery(session, table = "cytoBand")) %>%
  mutate(chrom = sub("^chr","", chrom))
ci <- GenomeInfoDb::getChromInfoFromUCSC("hg38") %>%
  transmute(chrom = sub("^chr","", chrom), chr_length_bp = size)
acen <- cyto %>% filter(gieStain == "acen") %>%
  group_by(chrom) %>% summarise(cent_start = min(chromStart), cent_end = max(chromEnd), .groups="drop")

arm_table <- ci %>% inner_join(acen, by = "chrom") %>%
  transmute(chromosome_name = chrom,
            p_len_bp = cent_start, q_len_bp = chr_length_bp - cent_end)

arm_sizes <- arm_table %>%
  pivot_longer(c(p_len_bp, q_len_bp), names_to = "arm", values_to = "len_bp") %>%
  mutate(arm = ifelse(arm == "p_len_bp", "p", "q"),
         chrom_arm = paste0(chromosome_name, arm),
         len_Mb = len_bp / 1e6)

# Map each gene to its arm
gene_arm <- gene_pos %>%
  inner_join(arm_table, by = "chromosome_name") %>%
  mutate(arm = ifelse(mid_bp < p_len_bp, "p", "q"),
         chrom_arm = paste0(chromosome_name, arm)) %>%
  select(ensembl_gene_id, chromosome_name, mid_bp, arm, chrom_arm)

```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

ARM_LEN_FLOOR_MB <- 5    # change to 1 if you prefer no/less floor

arm_rates_from_list <- function(sig_list, type_label = c("Unshrunken","Shrunken")[1]) {
  # Which LFC column to use for direction?
  dir_col <- if (identical(type_label, "Shrunken")) "lfc_shr" else "lfc_raw"

  # Build DEG table with direction per contrast
  deg_dir <- map_dfr(names(sig_list), function(cn){
    df <- sig_list[[cn]]
    if (is.null(df) || nrow(df) == 0)
      return(tibble(contrast = character(0), ensembl_gene_id = character(0), dir = character(0)))
    tibble(
      contrast        = cn,
      ensembl_gene_id = sub("\\..*$","", rownames(df)),
      dir             = ifelse(df[[dir_col]] > 0, "higher_in_Male", "higher_in_Female")
    )
  })

  # Count per arm and direction, then normalise by arm length
  deg_arm <- deg_dir %>%
    inner_join(gene_arm, by = "ensembl_gene_id") %>%
    count(contrast, chrom_arm, dir, name = "deg")

  rates_arm <- arm_sizes %>%
    select(chrom_arm, len_Mb) %>%
    inner_join(deg_arm, by = "chrom_arm") %>%
    mutate(rate_per_10Mb = deg / pmax(len_Mb / 10, ARM_LEN_FLOOR_MB / 10)) %>%
    mutate(Type = type_label)

  rates_arm
}

rates_raw <- arm_rates_from_list(results_sig_fc_raw, "Unshrunken")
rates_shr <- arm_rates_from_list(results_sig_fc,      "Shrunken")

rates_both <- bind_rows(rates_raw, rates_shr)


```


```{r fig.width=15, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

p_raw <- ggplot(rates_raw, aes(x = chrom_arm, y = rate_per_10Mb, fill = dir)) +
  geom_col(position = "dodge") +
  facet_wrap(~ contrast, ncol = 3, scales = "free_y") +
  scale_fill_manual(values = c("higher_in_Male"="tomato", "higher_in_Female"="royalblue"),
                    name = "Direction") +
  labs(title = "DEG distribution across chromosome arms — Unshrunken",
       subtitle = paste0("Normalised by arm size (DEGs per 10 Mb; floor ", ARM_LEN_FLOOR_MB, " Mb)"),
       x = "Chromosome arm", y = "DEGs per 10 Mb") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

p_shr <- ggplot(rates_shr, aes(x = chrom_arm, y = rate_per_10Mb, fill = dir)) +
  geom_col(position = "dodge") +
  facet_wrap(~ contrast, ncol = 3, scales = "free_y") +
  scale_fill_manual(values = c("higher_in_Male"="tomato", "higher_in_Female"="royalblue"),
                    name = "Direction") +
  labs(title = "DEG distribution across chromosome arms — Shrunken",
       subtitle = paste0("Normalised by arm size (DEGs per 10 Mb; floor ", ARM_LEN_FLOOR_MB, " Mb)"),
       x = "Chromosome arm", y = "DEGs per 10 Mb") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

# (B) Or, one grid with Type on rows
p_both <- ggplot(rates_both, aes(x = chrom_arm, y = rate_per_10Mb, fill = dir)) +
  geom_col(position = "dodge") +
  facet_grid(Type ~ contrast, scales = "free_y") +
  scale_fill_manual(values = c("higher_in_Male"="tomato", "higher_in_Female"="royalblue"),
                    name = "Direction") +
  labs(title = "DEG distribution across chromosome arms",
       subtitle = paste0("Normalised by arm size (DEGs per 10 Mb; floor ", ARM_LEN_FLOOR_MB, " Mb)"),
       x = "Chromosome arm", y = "DEGs per 10 Mb") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

# Show whichever you prefer:
p_raw
p_shr

```





```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


```







```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}




```



```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}



```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}




```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


```


```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}


```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}



```

```{r fig.width=11, fig.height=9, message=FALSE, warning=FALSE, echo=TRUE}

```


```{r fig.width=11, fig.height=13, message=FALSE, warning=FALSE, echo=TRUE}


```






















